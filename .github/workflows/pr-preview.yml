name: PR Preview (gh-pages previews)

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  pr-preview:
    runs-on: ubuntu-latest
    # Always run on these PR actions - the step content uses conditional checks
    if: github.event.pull_request.draft == false || github.event.action == 'opened' || github.event.action == 'synchronize' || github.event.action == 'reopened' || github.event.action == 'closed'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: collapse_web
        run: npm ci

      - name: Build site
        working-directory: collapse_web
        run: npm run build

      - name: Deploy preview to gh-pages under previews/pr-<number>
        if: github.event.pull_request.head.repo.full_name == github.repository && github.event.action != 'closed'
        env:
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.number }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          # clone if gh-pages branch exists, otherwise init an orphan branch
          git clone https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git gh-pages --depth=1 -b gh-pages || (
            mkdir gh-pages && cd gh-pages && git init && git remote add origin https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git && git fetch origin gh-pages || true && git checkout -b gh-pages
          )
          rm -rf gh-pages/previews/pr-${PR_NUMBER}
          mkdir -p gh-pages/previews/pr-${PR_NUMBER}
          cp -r collapse_web/docs/* gh-pages/previews/pr-${PR_NUMBER}/
          cd gh-pages
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add -A
          git commit -m "chore(preview): update PR ${PR_NUMBER} preview" || echo "No changes to commit"
          git push https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git gh-pages

      - name: Comment PR with preview URL
        if: github.event.action != 'closed'
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.number }}
          body: "Preview URL: https://$GITHUB_REPOSITORY_OWNER.github.io/${{ github.event.repository.name }}/previews/pr-${{ github.event.number }}/"

      - name: Wait for preview URL to be available
        if: github.event.action != 'closed'
        env:
          PREVIEW_URL: "https://$GITHUB_REPOSITORY_OWNER.github.io/${{ github.event.repository.name }}/previews/pr-${{ github.event.number }}/"
        run: |
          set -e
          echo "Waiting for preview URL: $PREVIEW_URL"
          for i in $(seq 1 30); do
            status=$(curl -s -o /dev/null -w "%{http_code}" "$PREVIEW_URL") || status=0
            echo "Attempt $i: HTTP $status"
            if [ "$status" -eq 200 ]; then
              echo "Preview is ready"
              exit 0
            fi
            sleep 3
          done
          echo "Preview did not respond with HTTP 200 after retries"
          exit 1

      - name: Run Playwright smoke tests against the preview
        if: github.event.pull_request.head.repo.full_name == github.repository && github.event.action != 'closed'
        working-directory: collapse_web
        env:
          SITE_URL: "https://$GITHUB_REPOSITORY_OWNER.github.io/${{ github.event.repository.name }}/previews/pr-${{ github.event.number }}/"
        run: |
          set -e
          # Install Playwright browsers
          npx playwright install --with-deps
          # Run mobile smoke tests with html reporter
          npx playwright test tests/smoke.mobile.spec.ts --project=chromium --workers=1 --retries=1 --reporter=html
          # Run desktop smoke tests with html reporter
          npx playwright test tests/smoke.spec.ts --project=chromium --workers=1 --retries=1 --reporter=html

      - name: Upload Playwright report artifact
        if: github.event.action != 'closed'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-pr-${{ github.event.number }}
          path: collapse_web/playwright-report

      - name: Run Playwright tests for fork PRs (local preview)
        if: github.event.pull_request.head.repo.full_name != github.repository && github.event.action != 'closed'
        working-directory: collapse_web
        env:
          SITE_URL: "http://127.0.0.1:5173/"
          SKIP_SW_CHECK: "true"
        run: |
          set -e
          # Start a local preview server in the background
          npm run preview -- --port 5173 &
          PREVIEW_PID=$!
          echo "Started preview server PID: $PREVIEW_PID"
          # Wait for local preview to be up
          for i in $(seq 1 30); do
            if curl -sSf "http://127.0.0.1:5173/" > /dev/null; then
              echo "Local preview ready"
              break
            fi
            sleep 2
          done
          # Install Playwright browsers
          npx playwright install --with-deps
          # Run tests against local preview (skip SW checks)
          npx playwright test tests/smoke.mobile.spec.ts --project=chromium --workers=1 --retries=1 --reporter=html
          npx playwright test tests/smoke.spec.ts --project=chromium --workers=1 --retries=1 --reporter=html
          kill $PREVIEW_PID || true

      - name: Upload Playwright report artifact (fork PR)
        if: github.event.pull_request.head.repo.full_name != github.repository && github.event.action != 'closed'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-pr-${{ github.event.number }}-fork
          path: collapse_web/playwright-report

      - name: Cleanup preview on PR close
        if: github.event.action == 'closed'
        env:
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.number }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git clone https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git gh-pages --depth=1 -b gh-pages || (
            mkdir gh-pages && cd gh-pages && git init && git remote add origin https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git && git fetch origin gh-pages || true && git checkout -b gh-pages
          )
          cd gh-pages
          rm -rf previews/pr-${PR_NUMBER}
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add -A
          git commit -m "chore(preview): remove preview for PR ${PR_NUMBER}" || echo "No changes to commit"
          git push https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git gh-pages

      - name: Comment PR preview removal
        if: github.event.action == 'closed'
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.number }}
          body: "Preview removed: PR #${{ github.event.number }} preview has been removed from GitHub Pages."
          
