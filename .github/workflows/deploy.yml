name: Build and Deploy PWA to GitHub Pages

on:
  push:
    branches: [ main ]
    # Ignore direct changes to the built docs; CI will produce and publish them
    paths-ignore:
      - 'collapse_web/docs/**'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: 'build-and-deploy-${{ github.ref }}'
      cancel-in-progress: true
    permissions:
      contents: write
      pages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install & build collapse_web
        working-directory: collapse_web
        run: |
          npm ci
          npm run build

      - name: Run unit tests (with coverage)
        working-directory: collapse_web
        run: |
          npm ci
          npm run test:coverage
          # Only enforce coverage threshold for pushes to main — allow feature branches and PRs to pass
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "Enforcing coverage threshold on main branch"
            node -e "const fs=require('fs'); const cov=JSON.parse(fs.readFileSync('coverage/coverage-summary.json')); const pct=cov.total.lines.pct; const min=80; if(pct<min){console.error('Coverage threshold not met: '+pct+' < '+min); process.exit(1);} else console.log('Coverage OK: '+pct+' >= '+min);"
          else
            echo "Not main branch — not enforcing coverage threshold"
          fi

      - name: Verify build output
        run: |
          if [ ! -f collapse_web/docs/index.html ]; then echo "Missing collapse_web/docs/index.html"; exit 1; fi
          if ! ls collapse_web/docs/assets | grep -E '^index-[A-Za-z0-9].*\.js$' >/dev/null 2>&1; then echo "Missing JS asset in collapse_web/docs/assets"; exit 1; fi
          # Assert that the index references assets that actually exist in the built folder
          INDEX_ASSETS=$(grep -Eo 'href="/[^\"]+assets/index-[A-Za-z0-9_.-]+\.css"|src="/[^\"]+assets/index-[A-Za-z0-9_.-]+\.js"' collapse_web/docs/index.html || true)
          if [ -z "$INDEX_ASSETS" ]; then echo "No assets referenced from index.html"; exit 1; fi
          for A in $INDEX_ASSETS; do
            FILE=$(echo $A | sed -E 's/^(src|href)="\/[^\"]*assets\/(index-[A-Za-z0-9_.-]+\.(css|js))"$/\2/');
            if [ -z "$FILE" ]; then echo "Unable to parse asset from: $A"; exit 1; fi
            if [ ! -f "collapse_web/docs/assets/$FILE" ]; then echo "Index references asset '$FILE' but file is missing in built assets"; exit 1; fi
          done

      - name: Abort if build files are already committed to this push
        run: |
          # On initial push, GITHUB_EVENT_BEFORE may be null/empty; guard that case
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            echo "Initial push; skipping built docs check"
            exit 0
          fi
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q '^collapse_web/docs/'; then
            echo "Detected changes to collapse_web/docs in push; please do NOT commit built docs to source. Remove built files and push again."
            exit 1
          fi

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: collapse_web/docs
          publish_branch: gh-pages
          user_name: "deploy bot"
          user_email: "deploy@local"
          clean: true

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: collapse_web/coverage

      - name: Verify remote gh-pages assets (retry)
        env:
          SITE_OWNER: ${{ github.repository_owner }}
          SITE_REPO: ${{ github.event.repository.name }}
        run: |
          SITE_URL="https://${SITE_OWNER}.github.io/${SITE_REPO}"
          echo "Verifying deployments on $SITE_URL ..."
          # Retrieve the site's index.html from the published pages and extract asset references
          set +e
          attempt=0
          max_attempts=8
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt+1))
            echo "Attempt $attempt/$max_attempts..."
            # fetch the site HTML
            body=$(curl -fsL "$SITE_URL/" || true)
            if [ -z "$body" ]; then echo "Failed to fetch $SITE_URL (empty body). Retrying..."; sleep 5; continue; fi
            # Extract script & css assets
            assets=$(echo "$body" | grep -Eo 'href="/[^\"]+assets/index-[A-Za-z0-9_.-]+\.css"|src="/[^\"]+assets/index-[A-Za-z0-9_.-]+\.js"' | sed -E 's/(src|href)="//g' | sed -E 's/"$//')
            if [ -z "$assets" ]; then echo "No assets found in site index. Retrying..."; sleep 5; continue; fi
            ok=0
            for a in $assets; do
              url="https://${SITE_OWNER}.github.io${a}"
              echo "Checking $url"
              if curl -fsL --max-time 15 "$url" >/dev/null; then
                ok=$((ok+1))
              else
                echo "Asset $url returned non-200, will retry"
                ok=-1
                break
              fi
            done
            if [ $ok -gt 0 ]; then
              echo "All referenced assets reachable from $SITE_URL"
              set -e
              exit 0
            fi
            sleep 6
          done
          set -e
          echo "Failed to verify remote gh-pages assets after $max_attempts attempts"; exit 1
      - name: Run Playwright smoke tests (browser)
        working-directory: collapse_web
        env:
          SITE_URL: "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        run: |
          npm ci
          npx playwright install --with-deps
          npm run smoke
          npm run smoke:mobile
          # Run heavier E2E tests only on main to validate flows end-to-end
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "Running E2E tests on main"
            npm run e2e
          else
            echo "Skipping full E2E on non-main branch"
          fi
